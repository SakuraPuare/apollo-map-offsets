# Pipeline å·¥ä½œæµç¨‹å›¾

## å®Œæ•´æµç¨‹

```
ç”¨æˆ·å‡†å¤‡æ–‡ä»¶
  â”œâ”€â”€ input/raw.json (åŠ å¯†æ•°æ®)
  â””â”€â”€ input/scenarios.json (åœºæ™¯ + åœ°å›¾è·¯å¾„)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 0: è§£å¯†åŸå§‹æ•°æ®                                     â”‚
â”‚   input/raw.json  â†’  input/data.json                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è‡ªåŠ¨æå–åœ°å›¾è·¯å¾„                                         â”‚
â”‚   scenarios.json â†’ modules/map/data/xxx/base_map.bin    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: è®¡ç®—åç§»é‡ï¼ˆåŒˆç‰™åˆ©ç®—æ³•ï¼‰                         â”‚
â”‚   input/scenarios.json + input/data.json                â”‚
â”‚              â†“                                          â”‚
â”‚   results/offset_results.json                           â”‚
â”‚   (Î”x, Î”y, Î¸, åŒ¹é…å¯¹)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å¯è§†åŒ–éªŒè¯                                       â”‚
â”‚   2a. åŒ¹é…åˆ†æå›¾è¡¨                                       â”‚
â”‚   2b. éšœç¢ç‰©è¯¦ç»†åˆ†æ                                     â”‚
â”‚              â†“                                          â”‚
â”‚   visualizations/*.png (5å¼ å›¾)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: åŒçº¿å¹¶è¡Œå¤„ç†                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼

ğŸ”¸ åœºæ™¯å¤„ç†çº¿          ğŸ”¸ åœ°å›¾å¤„ç†çº¿ (3a)    ğŸ”¸ åœ°å›¾å¤„ç†çº¿ (3b)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4:      â”‚     â”‚ Step 3:      â”‚     â”‚ Step 5:      â”‚
â”‚ åˆ›å»ºæ–°åœºæ™¯    â”‚     â”‚ åº”ç”¨åç§»åˆ°    â”‚     â”‚ ç”Ÿæˆ sim_map â”‚
â”‚              â”‚     â”‚ åœ°å›¾         â”‚     â”‚              â”‚
â”‚ scenarios    â”‚     â”‚              â”‚     â”‚ (Dreamview   â”‚
â”‚  + data      â”‚     â”‚ base_map +   â”‚     â”‚  æ˜¾ç¤ºç”¨)     â”‚
â”‚  + offset    â”‚     â”‚  offset      â”‚     â”‚              â”‚
â”‚              â”‚     â”‚              â”‚     â”‚ offset_map   â”‚
â”‚      â†“       â”‚     â”‚      â†“       â”‚     â”‚  + downsampleâ”‚
â”‚ scenarios_   â”‚     â”‚ offset_map.  â”‚     â”‚      â†“       â”‚
â”‚  new.json    â”‚     â”‚  bin         â”‚     â”‚ sim_map.bin  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æœ€ç»ˆè¾“å‡º       â”‚
                    â”‚                â”‚
                    â”‚ ğŸ“„ åœºæ™¯:       â”‚
                    â”‚  scenarios_    â”‚
                    â”‚   new.json     â”‚
                    â”‚                â”‚
                    â”‚ ğŸ—ºï¸  åœ°å›¾:      â”‚
                    â”‚  offset_map.   â”‚
                    â”‚   bin          â”‚
                    â”‚  sim_map.bin   â”‚
                    â”‚  sim_map.txt   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµè¯¦è§£

### è¾“å…¥é˜¶æ®µ
1. **raw.json** (å¯é€‰)
   - åŠ å¯†æ ¼å¼ï¼šBase64 + AES-CBC
   - å¯†é’¥ï¼šSHA256("æ˜æœˆå‡ æ—¶æœ‰")
   - è§£å¯†å â†’ `data.json`

2. **scenarios.json**
   - åŒ…å«åœºæ™¯å®šä¹‰
   - åŒ…å«åœ°å›¾è·¯å¾„ï¼š`scenario.roadNetwork.logicFile.filepath`
   - è‡ªåŠ¨æå– â†’ æ‰¾åˆ° `base_map.bin`

### å¤„ç†é˜¶æ®µ

#### Step 1: åç§»è®¡ç®—
- **è¾“å…¥**: scenarios.json, data.json
- **ç®—æ³•**: åŒˆç‰™åˆ©ç®—æ³•ï¼ˆHungarian Algorithmï¼‰
- **è¾“å‡º**: offset_results.json
  ```json
  {
    "transformation": {
      "translation": { "x": 8993.72, "y": 8996.94 },
      "rotation_degrees": -0.53
    },
    "matches": [ ... ]
  }
  ```

#### Step 2: å¯è§†åŒ–
- **2a - åŒ¹é…åˆ†æ**:
  - åŸå§‹ä½ç½®å¯¹æ¯”
  - åç§»åå åŠ 
  - å‘é‡åœº
- **2b - éšœç¢ç‰©åˆ†æ**:
  - å°ºå¯¸åˆ†å¸ƒ
  - ç±»å‹ç»Ÿè®¡
  - è¾¹ç•Œæ¡†å¯è§†åŒ–

#### Step 3: åŒçº¿å¤„ç†

**ğŸ”¸ åœºæ™¯å¤„ç†çº¿ (Step 4)**
```
scenarios.json (æ¨¡æ¿)
    +
data.json (æ–°æ•°æ®)
    +
offset_results.json (åç§»)
    â†“
scenarios_new.json
```

**ğŸ”¸ åœ°å›¾å¤„ç†çº¿ (Step 3 + 5)**
```
Step 3a: åº”ç”¨åç§»
  base_map.bin
      +
  offset_results.json
      â†“
  offset_map.bin

Step 3b: ç”Ÿæˆ sim_map
  offset_map.bin
      â†“
  [sim_map_generator]
      â†“
  sim_map.bin  (Dreamview æ˜¾ç¤ºç”¨)
  sim_map.txt  (è°ƒè¯•ç”¨)
```

## å…³é”®æŠ€æœ¯ç‚¹

### 1. è‡ªåŠ¨åœ°å›¾è·¯å¾„æå–
```python
# ä» scenarios.json è‡ªåŠ¨æå–
scenario.roadNetwork.logicFile.filepath
  â†’ "modules/map/data/xh_2025_gs_contest"
  â†’ /apollo_workspace/modules/map/data/xh_2025_gs_contest/base_map.bin
```

### 2. å¹¶è¡Œå¤„ç†è®¾è®¡
- åœºæ™¯å¤„ç†çº¿å’Œåœ°å›¾å¤„ç†çº¿å¯å¹¶è¡Œ
- äº’ä¸ä¾èµ–ï¼Œæé«˜æ•ˆç‡
- ç”¨æˆ·å¯é€‰æ‹©æ€§è¿è¡Œ

### 3. sim_map ç”Ÿæˆ
- ä½¿ç”¨ Apollo åŸç”Ÿå·¥å…· `sim_map_generator`
- ä¸‹é‡‡æ ·ä¼˜åŒ–æ˜¾ç¤ºæ€§èƒ½
- æ”¯æŒè‡ªå®šä¹‰é‡‡æ ·å‚æ•°

## è¾“å‡ºæ–‡ä»¶è¯´æ˜

### è®¡ç®—ç»“æœ
- `results/offset_results.json` - å®Œæ•´åç§»è®¡ç®—ç»“æœ

### å¯è§†åŒ–
- `visualizations/01_matching_overview.png` - 6å­å›¾æ€»è§ˆ
- `visualizations/02_detailed_matching.png` - è¯¦ç»†åŒ¹é…
- `visualizations/03_vector_field.png` - å‘é‡åœº
- `visualizations/04_obstacles_detailed.png` - éšœç¢ç‰©åˆ†æ
- `visualizations/05_obstacles_boxes.png` - è¾¹ç•Œæ¡†å¯è§†åŒ–

### æœ€ç»ˆè¾“å‡º
- `output/scenarios_new.json` - åç§»åçš„åœºæ™¯æ–‡ä»¶
- `output/offset_map.bin` - åç§»åçš„åœ°å›¾æ–‡ä»¶
- `output/sim_map/sim_map.bin` - Dreamview æ˜¾ç¤ºç”¨åœ°å›¾
- `output/sim_map/sim_map.txt` - åœ°å›¾æ–‡æœ¬æ ¼å¼ï¼ˆè°ƒè¯•ç”¨ï¼‰

## ä½¿ç”¨å»ºè®®

### å®Œæ•´è¿è¡Œï¼ˆæ¨èï¼‰
```bash
python3 run_pipeline.py
```
è‡ªåŠ¨å¤„ç†æ‰€æœ‰æ­¥éª¤ï¼Œæ™ºèƒ½æå–åœ°å›¾è·¯å¾„ã€‚

### åªç”Ÿæˆåœºæ™¯
```bash
python3 step1_calculate_offset.py
python3 step4_create_scenario.py
```

### åªå¤„ç†åœ°å›¾
```bash
python3 step1_calculate_offset.py
python3 step3_apply_offset_to_map.py <map> output/offset_map.bin
python3 step5_generate_sim_map.py --map_dir output
```

### è°ƒè¯•æŸä¸ªæ­¥éª¤
æ¯ä¸ªæ­¥éª¤éƒ½å¯ç‹¬ç«‹è¿è¡Œï¼Œä¾¿äºè°ƒè¯•å’ŒéªŒè¯ã€‚
